"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cancelJob = exports.scheduleJob = void 0;
/**
 * The main class and interface of the schedule module
 */
const PriorityQueue = require("./priorityQueue");
const Job = require("./job");
const pinus_logger_1 = require("pinus-logger");
const path = require("path");
let logger = pinus_logger_1.getLogger('pinus-scheduler', path.basename(__filename));
let timerCount = 0;
let map = {};
let queue = PriorityQueue.createPriorityQueue(comparator);
let jobId = 0;
let timer;
// The accuracy of the scheduler, it will affect the performance when the schedule tasks are
// crowded together
let accuracy = 10;
/**
 * Schedule a new Job
 * @param trigger The trigger to use
 * @param jobFunc The function the job to run
 * @param jobData The data the job use
 * @return The job id, which can be canceled by cancelJob(id:number)
 */
function scheduleJob(trigger, jobFunc, jobData) {
    let job = Job.createJob(trigger, jobFunc, jobData);
    let excuteTime = job.excuteTime();
    let id = job.id;
    map[id] = job;
    let element = {
        id: id,
        time: excuteTime
    };
    let curJob = queue.peek();
    if (!curJob || excuteTime < curJob.time) {
        queue.offer(element);
        setTimer(job);
        return job.id;
    }
    queue.offer(element);
    return job.id;
}
exports.scheduleJob = scheduleJob;
/**
 * Cancel Job
 */
function cancelJob(id) {
    let curJob = queue.peek();
    if (curJob && id === curJob.id) { // to avoid queue.peek() is null
        queue.pop();
        delete map[id];
        clearTimeout(timer);
        excuteJob();
    }
    delete map[id];
    return true;
}
exports.cancelJob = cancelJob;
/**
 * Clear last timeout and schedule the next job, it will automaticly run the job that
 * need to run now
 * @param job The job need to schedule
 * @return void
 */
function setTimer(job) {
    clearTimeout(timer);
    timer = setTimeout(excuteJob, job.excuteTime() - Date.now());
}
/**
 * The function used to ran the schedule job, and setTimeout for next running job
 */
function excuteJob() {
    let job = peekNextJob();
    let nextJob;
    while (!!job && (job.excuteTime() - Date.now()) < accuracy) {
        job.run();
        queue.pop();
        let nextTime = job.nextTime();
        if (nextTime === null) {
            delete map[job.id];
        }
        else {
            queue.offer({ id: job.id, time: nextTime });
        }
        job = peekNextJob();
    }
    // If all the job have been canceled
    if (!job)
        return;
    // Run next schedule
    setTimer(job);
}
/**
 * Return, but not remove the next valid job
 * @return Next valid job
 */
function peekNextJob() {
    if (queue.size() <= 0)
        return null;
    let job = null;
    do {
        job = map[queue.peek().id];
        if (!job)
            queue.pop();
    } while (!job && queue.size() > 0);
    return (!!job) ? job : null;
}
/**
 * Return and remove the next valid job
 * @return Next valid job
 */
function getNextJob() {
    let job = null;
    while (!job && queue.size() > 0) {
        let id = queue.pop().id;
        job = map[id];
    }
    return (!!job) ? job : null;
}
function comparator(e1, e2) {
    return e1.time > e2.time;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvc2NoZWR1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUE7O0dBRUc7QUFDSCxpREFBaUQ7QUFDakQsNkJBQTZCO0FBSTdCLCtDQUF5QztBQUN6Qyw2QkFBNkI7QUFDN0IsSUFBSSxNQUFNLEdBQUcsd0JBQVMsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFFckUsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO0FBQ25CLElBQUksR0FBRyxHQUE2QixFQUFFLENBQUM7QUFDdkMsSUFBSSxLQUFLLEdBQUcsYUFBYSxDQUFDLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBRTFELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBVSxDQUFDO0FBRWYsNEZBQTRGO0FBQzVGLG1CQUFtQjtBQUNuQixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7QUFFbEI7Ozs7OztHQU1HO0FBQ0gsU0FBUyxXQUFXLENBQUksT0FBbUMsRUFBRSxPQUEyQixFQUFFLE9BQVc7SUFDakcsSUFBSSxHQUFHLEdBQVksR0FBRyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzVELElBQUksVUFBVSxHQUFHLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUNsQyxJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBRWhCLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUM7SUFDZCxJQUFJLE9BQU8sR0FBRztRQUNWLEVBQUUsRUFBRSxFQUFFO1FBQ04sSUFBSSxFQUFFLFVBQVU7S0FDbkIsQ0FBQztJQUVGLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMxQixJQUFJLENBQUMsTUFBTSxJQUFJLFVBQVUsR0FB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